{% extends "layout.html" %}

{% block title %}{{ post.title if post.title else 'ê°ì • ì¼ê¸°' }} - Moodiary{% endblock %}

{% block content %}
  {% if post.emotion %}
    <p class="post-emotion">ğŸ§  ê°ì • ë¶„ì„ ê²°ê³¼: {{ post.emotion }}</p>
  {% endif %}
  <article class="post-detail">
    <h2>{{ post.title if post.title else '[ì œëª© ì—†ëŠ” ê°ì •]' }}</h2>

    <p class="post-content">{{ post.content }}</p>
    <p class="post-meta">
      ì‘ì„±ì: <strong>{{ post.author.name }}</strong> |
      {{ post.created_at|format_kst }}
    </p>
    <div class="likes">
      â¤ï¸ ê³µê° <span>{{ post.likes | length }}ê°œ</span>
    </div>

    {% if current_user.is_authenticated and current_user.id == post.author.id %}
      <details class="edit-box">
        <summary>âœï¸ ìˆ˜ì •í•˜ê¸°</summary>
        <form method="post">
          <label>ì œëª©:</label>
          <input type="text" name="title" value="{{ post.title }}" required>

          <label>ë‚´ìš©:</label>
          <textarea name="content" rows="6" required>{{ post.content }}</textarea>

          <button type="submit" >ìˆ˜ì • ì™„ë£Œ</button>
        </form>
      </details>
    {% endif %}
  </article>
  <div style="display: flex; gap: 10px;">
    {% if current_user.is_authenticated %}
      {% set liked = false %}
      {% for like in post.likes %}
        {% if like.user.id == current_user.id %}
          {% set liked = true %}
        {% endif %}
      {% endfor %}

      <form action="{{ url_for('like', post_id=post.id) }}" method="post">
        <button type="submit">
          {% if liked %}
            ê³µê° ì·¨ì†Œí•˜ê¸°
          {% else %}
            ê³µê°í•˜ê¸°
          {% endif %}
        </button>
      </form>

      {% if current_user.is_authenticated and current_user.id == post.author.id %}
        <form method="post" action="{{ url_for('delete_post', post_id=post.id) }}" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
          <button type="submit">ì‚­ì œí•˜ê¸°</button>
        </form>
      {% endif %}
    {% endif %}
  </div>

  <section class="comments">
    <h3>ğŸ’¬ ëŒ“ê¸€</h3>
    {% for comment in comments.items %}
      <div class="comment-box">
        <p class="comment-meta">
          <strong>{{ comment.user.name }}</strong> ({{ comment.created_at|format_kst }}):
        </p>
        <p>{{ comment.content }}</p>

        {% if current_user.is_authenticated and current_user.id == comment.user_id %}
          <!-- <form method="post" action="{{ url_for('delete_comment', comment_id=comment.id) }}" style="display:inline-block;">
            <button type="submit" >ì‚­ì œí•˜ê¸°</button>
          </form> -->
          <details class="edit-comment">
            <summary>âœï¸ ìˆ˜ì •í•˜ê¸°</summary>
            <form method="post" action="{{ url_for('edit_comment', comment_id=comment.id) }}">
              <textarea name="content" rows="2" required>{{ comment.content }}</textarea>
              <button type="submit" >ìˆ˜ì • ì™„ë£Œ</button>
            </form>
          </details>
        {% endif %}
      </div>
      {% if current_user.is_authenticated and current_user.id == comment.user_id %}
        <form method="post" action="{{ url_for('delete_comment', comment_id=comment.id) }}" style="display:inline-block;">
          <button type="submit" >ì‚­ì œí•˜ê¸°</button>
        </form>
      {% endif %}
    {% else %}
      <p class="no-comment">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endfor %}

    <div class="pagination">
      {% if comments.has_prev %}
        <a href="{{ url_for('post_detail', post_id=post.id, page=comments.prev_num) }}">Â« ì´ì „</a>
      {% endif %}

      {% for p in range(1, comments.pages + 1) %}
        <a href="{{ url_for('post_detail', post_id=post.id, page=p) }}" {% if p == comments.page %}class="active"{% endif %}>{{ p }}</a>
      {% endfor %}

      {% if comments.has_next %}
        <a href="{{ url_for('post_detail', post_id=post.id, page=comments.next_num) }}">ë‹¤ìŒ Â»</a>
      {% endif %}
    </div>

    {% if current_user.is_authenticated %}
      <form method="post" action="{{ url_for('add_comment', post_id=post.id) }}" class="comment-form">
        <textarea name="content" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”." required></textarea>
        <button type="submit" >ëŒ“ê¸€ ì‘ì„±</button>
      </form>
    {% else %}
      <p class="notice">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="{{ url_for('login') }}">ë¡œê·¸ì¸</a> í•´ì£¼ì„¸ìš”.</p>
    {% endif %}

  </section>

  
{% endblock %}
